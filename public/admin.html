<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartSummary - Administration</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="container">
    <header>
      <div class="logo-container">
        <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" class="smart-summary-logo">
          <defs>
            <linearGradient id="gradBrain" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#a78bfa;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
            </linearGradient>
            <linearGradient id="gradRing" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#ec4899;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#a78bfa;stop-opacity:1" />
            </linearGradient>
          </defs>
          <path fill="none" stroke="url(#gradBrain)" stroke-width="2.5" d="M 60 70 Q 50 60 50 80 Q 50 95 60 100 Q 65 102 70 100 Q 75 98 75 85 Q 75 70 65 65 Z" />
          <path fill="none" stroke="url(#gradBrain)" stroke-width="2.5" d="M 140 70 Q 150 60 150 80 Q 150 95 140 100 Q 135 102 130 100 Q 125 98 125 85 Q 125 70 135 65 Z" />
          <circle fill="url(#gradBrain)" cx="65" cy="75" r="2" />
          <circle fill="url(#gradBrain)" cx="80" cy="80" r="2" />
          <circle fill="url(#gradBrain)" cx="100" cy="75" r="2" />
          <circle fill="url(#gradBrain)" cx="120" cy="80" r="2" />
          <circle fill="url(#gradBrain)" cx="135" cy="75" r="2" />
          <circle fill="url(#gradBrain)" cx="70" cy="95" r="2" />
          <circle fill="url(#gradBrain)" cx="100" cy="98" r="2" />
          <circle fill="url(#gradBrain)" cx="130" cy="95" r="2" />
          <line stroke="url(#gradBrain)" stroke-width="1.5" x1="65" y1="75" x2="80" y2="80" />
          <line stroke="url(#gradBrain)" stroke-width="1.5" x1="80" y1="80" x2="100" y2="75" />
          <line stroke="url(#gradBrain)" stroke-width="1.5" x1="100" y1="75" x2="120" y2="80" />
          <line stroke="url(#gradBrain)" stroke-width="1.5" x1="120" y1="80" x2="135" y2="75" />
          <line stroke="url(#gradBrain)" stroke-width="1.5" x1="70" y1="95" x2="100" y2="98" />
          <line stroke="url(#gradBrain)" stroke-width="1.5" x1="100" y1="98" x2="130" y2="95" />
          <path fill="none" stroke="url(#gradRing)" stroke-width="3" stroke-linecap="round" d="M 70 140 A 60 25 0 0 1 130 140" stroke-dasharray="95,120" />
          <circle cx="100" cy="100" r="95" fill="none" stroke="url(#gradRing)" stroke-width="0.5" opacity="0.3" stroke-dasharray="300" />
        </svg>
        <h1>SmartSummary</h1>
      </div>
      <div class="nav-buttons">
        <a href="/dashboard.html" class="nav-link">‚Üê Retour</a>
      </div>
      <div>
        <span id="currentUser"></span>
        <button id="logoutBtn">D√©connexion</button>
      </div>
    </header>

    <section class="card">
      <h2>üìä Statistiques</h2>
      <div id="statsArea" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
          <p style="color: var(--text-secondary); font-size: 0.9rem;">Total Utilisateurs</p>
          <p style="font-size: 2rem; font-weight: bold;" id="statUsers">-</p>
        </div>
        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
          <p style="color: var(--text-secondary); font-size: 0.9rem;">Total Sessions</p>
          <p style="font-size: 2rem; font-weight: bold;" id="statSessions">-</p>
        </div>
        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
          <p style="color: var(--text-secondary); font-size: 0.9rem;">Total R√©sum√©s</p>
          <p style="font-size: 2rem; font-weight: bold;" id="statSummaries">-</p>
        </div>
        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
          <p style="color: var(--text-secondary); font-size: 0.9rem;">Utilisateurs V√©rifi√©s</p>
          <p style="font-size: 2rem; font-weight: bold;" id="statVerified">-</p>
        </div>
        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
          <p style="color: var(--text-secondary); font-size: 0.9rem;">Moyenne Sessions/User</p>
          <p style="font-size: 2rem; font-weight: bold;" id="statAvg">-</p>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>üë• Gestion des Utilisateurs</h2>
      <div id="usersList">
        <p class="empty-state">Chargement...</p>
      </div>
    </section>
  </main>

  <script src="api.js"></script>
  <script src="auth-check.js"></script>
  <script>
    const statsArea = document.getElementById("statsArea");
    const usersList = document.getElementById("usersList");
    const currentUserSpan = document.getElementById("currentUser");
    const logoutBtn = document.getElementById("logoutBtn");

    // Auth and role checked by auth-check.js
    const userJson = localStorage.getItem("smartsummary_user");
    if (userJson && currentUserSpan) {
      try {
        const user = JSON.parse(userJson);
        currentUserSpan.textContent = user.name + " (" + user.email + ")";
      } catch (e) {
        console.error("Error parsing user:", e);
      }
    }

    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        const refreshToken = localStorage.getItem("smartsummary_refreshToken");
        try {
          if (refreshToken) {
            await fetch("/api/logout", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ refreshToken }),
            });
          }
        } catch (err) {
          console.error("Logout error:", err);
        }
        localStorage.removeItem("smartsummary_accessToken");
        localStorage.removeItem("smartsummary_refreshToken");
        localStorage.removeItem("smartsummary_user");
        window.location.href = "/";
      });
    }

    async function loadStats() {
      try {
        const accessToken = localStorage.getItem("smartsummary_accessToken");
        const res = await fetch("/api/stats", {
          headers: { Authorization: `Bearer ${accessToken}` },
        });
        if (res.status === 401) {
          window.location.href = "/";
          return;
        }
        const json = await res.json();
        if (json.ok && json.stats) {
          document.getElementById("statUsers").textContent = json.stats.totalUsers || 0;
          document.getElementById("statSessions").textContent = json.stats.totalSessions || 0;
          document.getElementById("statSummaries").textContent = json.stats.totalSummaries || 0;
          document.getElementById("statVerified").textContent = json.stats.verifiedUsers || 0;
          document.getElementById("statAvg").textContent = json.stats.avgSessionsPerUser || 0;
        }
      } catch (err) {
        console.error("Error loading stats:", err);
      }
    }

    async function loadUsers() {
      try {
        const accessToken = localStorage.getItem("smartsummary_accessToken");
        const res = await fetch("/api/admin/users", {
          headers: { Authorization: `Bearer ${accessToken}` },
        });
        if (res.status === 401 || res.status === 403) {
          window.location.href = "/";
          return;
        }
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || "Erreur");

        if (json.users.length === 0) {
          usersList.innerHTML = '<p class="empty-state">Aucun utilisateur</p>';
          return;
        }

        usersList.innerHTML = `
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 2px solid var(--border-color);">
                <th style="text-align: left; padding: 0.75rem;">Nom</th>
                <th style="text-align: left; padding: 0.75rem;">Email</th>
                <th style="text-align: left; padding: 0.75rem;">R√¥le</th>
                <th style="text-align: left; padding: 0.75rem;">Sessions</th>
                <th style="text-align: left; padding: 0.75rem;">V√©rifi√©</th>
                <th style="text-align: left; padding: 0.75rem;">Actions</th>
              </tr>
            </thead>
            <tbody>
              ${json.users.map((user) => `
                <tr style="border-bottom: 1px solid var(--border-color);">
                  <td style="padding: 0.75rem;">${user.name}</td>
                  <td style="padding: 0.75rem;">${user.email}</td>
                  <td style="padding: 0.75rem;">${user.role}</td>
                  <td style="padding: 0.75rem;">${user.sessionCount || 0}</td>
                  <td style="padding: 0.75rem;">${user.verified ? "‚úÖ" : "‚ùå"}</td>
                  <td style="padding: 0.75rem;">
                    <button class="btn-secondary" onclick="deleteUser(${user.id}, '${user.email}')">Supprimer</button>
                  </td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        `;
      } catch (err) {
        usersList.innerHTML = `<p class="empty-state error">Erreur: ${err.message}</p>`;
      }
    }

    async function deleteUser(id, email) {
      if (!confirm(`√ätes-vous s√ªr de vouloir supprimer l'utilisateur "${email}" ? Cette action est irr√©versible et supprimera toutes ses sessions.`)) {
        return;
      }

      try {
        const accessToken = localStorage.getItem("smartsummary_accessToken");
        const res = await fetch(`/api/admin/users/${id}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${accessToken}` },
        });

        if (res.ok) {
          loadUsers();
          loadStats();
        } else {
          const json = await res.json();
          alert("Erreur: " + (json.error || "√âchec de la suppression"));
        }
      } catch (err) {
        alert("Erreur: " + err.message);
      }
    }

    window.deleteUser = deleteUser;
    loadStats();
    loadUsers();
  </script>
</body>
</html>

